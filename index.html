<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gateway Properties Map</title>

  <!-- Your stylesheet -->
  <link rel="stylesheet" href="styles/app.css" />
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" />
  <!-- MarkerCluster CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

  <style>
    /* Fallback map height so it always shows */
    #map { height: 70vh; min-height: 520px; }
    .leaflet-container { background: #eef2f7; }

    /* Counter pill + legend styles */
    .count-pill{
      background:#ffffffcc; backdrop-filter: blur(3px);
      border-radius:9999px; padding:6px 10px;
      font:13px/1.1 system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      color:#0f172a; box-shadow:0 2px 8px rgba(0,0,0,.12); border:1px solid #e5e7eb;
    }
    .legend-box{
      background:#ffffffcc; backdrop-filter: blur(3px);
      border-radius:10px; padding:10px 12px;
      font:13px/1.1 system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      color:#0f172a; box-shadow:0 2px 8px rgba(0,0,0,.12); border:1px solid #e5e7eb;
    }
    .legend-box h4{ margin:0 0 8px; font-size:12px; color:#334155; }
    .legend-row{ display:grid; grid-template-columns:18px 1fr; gap:8px; align-items:center; margin:4px 0; }
    .sw{ width:16px; height:16px; box-shadow:0 1px 2px rgba(0,0,0,.15); border:2px solid #fff; }
    .sw.circle{ border-radius:50%; }
    .sw.square{ border-radius:4px; }
    .sw.diamond{ transform:rotate(45deg); border-radius:3px; }
    .sw.star{ clip-path:polygon(50% 0%,61% 35%,98% 35%,68% 57%,79% 91%,50% 70%,21% 91%,32% 57%,2% 35%,39% 35%); }

    /* Error overlay (so we never get a blank white page) */
    .err-overlay{
      position:fixed; inset:0; background:#fff; color:#111827; padding:24px;
      font:14px/1.4 ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      overflow:auto; z-index:99999; display:none;
    }
    .err-overlay pre{ white-space:pre-wrap; word-break:break-word; }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="gaHeader">
    <h1>Gateway Properties Map</h1>
    <p class="sub">Property Filters</p>
  </div>

  <!-- Toolbar -->
  <div class="toolbar">
    <div class="group">
      <label for="rvpFilter">RVP</label>
      <select id="rvpFilter"><option value="All">All</option></select>
    </div>
    <div class="group">
      <label for="rpmFilter">Regional Manager</label>
      <select id="rpmFilter"><option value="All">All</option></select>
    </div>
    <div class="group">
      <label for="stateFilter">State</label>
      <select id="stateFilter">
        <option value="All">All</option>
        <option>AL</option><option>FL</option><option>GA</option><option>KS</option>
        <option>LA</option><option>NC</option><option>OK</option><option>SC</option>
        <option>TN</option><option>VA</option>
      </select>
    </div>
    <div class="group">
      <label for="typeFilter">Property Type</label>
      <select id="typeFilter">
        <option value="All">All</option>
        <option>55</option><option>62</option><option>C</option>
        <option>F</option><option>RD-62</option><option>S</option>
      </select>
    </div>
    <div class="group">
      <label for="ownerFilter">Owner</label>
      <select id="ownerFilter"><option value="All">All</option></select>
    </div>
    <div class="group">
      <label for="legalFilter">Legal Entity</label>
      <select id="legalFilter"><option value="All">All</option></select>
    </div>
  </div>

  <!-- Map -->
  <div id="map" class="map"></div>

  <!-- Error overlay -->
  <div id="err" class="err-overlay"><h2>Script error</h2><pre id="errMsg"></pre></div>

  <!-- Leaflet JS -->
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- MarkerCluster JS -->
  <script src="https://cdn.jsdelivr.net/npm/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <script>
    // Show any runtime error in an overlay
    (function(){
      function showErr(msg){
        var box = document.getElementById('err');
        var pre = document.getElementById('errMsg');
        if (box && pre){ pre.textContent = msg; box.style.display='block'; }
      }
      window.onerror = function (m, src, ln, col, err) {
        showErr([m, src+':'+ln+':'+col, err && err.stack ? '\n'+err.stack : ''].join('\n'));
        return false;
      };
      window.addEventListener('unhandledrejection', function(e){
        showErr('Unhandled promise rejection:\n' + (e.reason && e.reason.stack ? e.reason.stack : String(e.reason)));
      });
    })();

    document.addEventListener('DOMContentLoaded', function(){
      try {
        // ---- Utilities ----
        const uniqueSorted = arr => [...new Set(arr.filter(Boolean))].sort((a,b)=>a.localeCompare(b));
        function addOptions(selectId, values) {
          const sel = document.getElementById(selectId);
          if (!sel) return;
          [...sel.querySelectorAll('option:not([value="All"])')].forEach(o => o.remove());
          values.forEach(v => {
            const opt = document.createElement('option');
            opt.value = v; opt.textContent = v;
            sel.appendChild(opt);
          });
        }
        function getMarkerOptions(type) {
          switch (type) {
            case '55':    return { color: '#60d5d7', shape: 'circle' };   // teal circle
            case '62':    return { color: '#10b981', shape: 'circle' };   // green circle
            case 'F':     return { color: '#f59e0b', shape: 'square' };   // amber square
            case 'C':     return { color: '#8b5cf6', shape: 'diamond' };  // purple diamond
            case 'S':     return { color: '#ef4444', shape: 'star' };     // red star
            case 'RD-62': return { color: '#10b981', shape: 'circle' };   // green circle
            default:      return { color: '#3b82f6', shape: 'circle' };   // blue circle
          }
        }
        function makeMarker(prop) {
          const opt = getMarkerOptions(prop.type);
          let css = `width:20px;height:20px;background:${opt.color};box-shadow:0 2px 4px rgba(0,0,0,.2);`;
          if (opt.shape==='circle') css += 'border-radius:50%;';
          else if (opt.shape==='square') css += 'border-radius:4px;';
          else if (opt.shape==='diamond') css += 'transform:rotate(45deg);border-radius:3px;';
          else if (opt.shape==='star') css += 'clip-path:polygon(50% 0%,61% 35%,98% 35%,68% 57%,79% 91%,50% 70%,21% 91%,32% 57%,2% 35%,39% 35%);';
          const icon = L.divIcon({ html:`<div style="${css}"></div>`, className:'custom-div-icon', iconSize:[20,20], iconAnchor:[10,10] });
          const m = L.marker([prop.lat, prop.lng], { icon });
          m.bindPopup(
            `<div style="font-family:system-ui,sans-serif;min-width:280px">
              <h3 style="margin:0 0 8px;color:#073b3d;border-bottom:1px solid #60d5d7;padding-bottom:4px">${prop.name} üè†</h3>
              <p><strong>Type:</strong> ${prop.type} &nbsp;|&nbsp; <strong>Units:</strong> ${prop.units ?? ''}</p>
              <p><strong>Address:</strong> ${prop.address}<br>${prop.city}, ${prop.state} ${prop.zip ?? ''}</p>
              <p><strong>Manager:</strong> ${prop.manager ?? ''}<br>
                 <a href="mailto:${prop.manager_email ?? ''}" style="color:#0ea5e9">${prop.manager_email ?? ''}</a></p>
              <p><strong>RVP:</strong> ${prop.rvp ?? ''} &nbsp;|&nbsp; <strong>Regional:</strong> ${prop.rpm ?? ''}</p>
              <small style="color:#6b7280;border-top:1px solid #e5e7eb;padding-top:4px;display:block">
                Owner: ${prop.owner ?? 'N/A'} &nbsp;|&nbsp; Legal: ${prop.legal_entity ?? 'N/A'} &nbsp;|&nbsp; Phone: ${prop.office_phone ?? 'N/A'}
              </small>
            </div>`
          );
          return m;
        }

        // ---- Map init ----
        if (!window.L) throw new Error("Leaflet failed to load (window.L undefined)");
        const map = L.map('map', { zoomControl: true }).setView([34.5, -86.6], 6);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        // Marker clustering with spiderfy for stacked points
        const markersGroup = L.markerClusterGroup({
          spiderfyOnMaxZoom: true,
          showCoverageOnHover: false,
          zoomToBoundsOnClick: true,
          disableClusteringAtZoom: 18,   // separate when zoomed in close
          maxClusterRadius: 50           // px; lower = separate sooner
        }).addTo(map);

        window.addEventListener('load', () => map.invalidateSize());
        setTimeout(() => map.invalidateSize(), 300);

        // ---- Counter control ----
        let totalPortfolio = 0; // total rows in JSON
        let totalEligible  = 0; // rows with usable coords
        const counterCtl = L.control({ position: 'bottomleft' });
        counterCtl.onAdd = function() {
          const div = L.DomUtil.create('div', 'count-pill');
          div.id = 'countPill';
          div.textContent = '0 visible ‚Ä¢ 0 / 0';
          return div;
        };
        counterCtl.addTo(map);
        function updateCounts(visible) {
          const pill = document.getElementById('countPill');
          if (pill) pill.textContent = `${visible} visible ‚Ä¢ ${totalEligible} / ${totalPortfolio}`;
        }

        // ---- Legend control ----
        function legendHTML() {
          const items = [
            {label:'55+',   type:'55'},
            {label:'62+',   type:'62'},
            {label:'Family',type:'F'},
            {label:'Conv.', type:'C'},
            {label:'Senior',type:'S'},
            {label:'RD-62', type:'RD-62'},
          ];
          const rows = items.map(it => {
            const opt = getMarkerOptions(it.type);
            const shape = opt.shape || 'circle';
            return `<div class="legend-row">
              <div class="sw ${shape}" style="background:${opt.color}"></div>
              <div>${it.label}</div>
            </div>`;
          }).join('');
          return `<div class="legend-box"><h4>Legend</h4>${rows}</div>`;
        }
        const legendCtl = L.control({ position: 'bottomright' });
        legendCtl.onAdd = function(){
          const div = L.DomUtil.create('div');
          div.innerHTML = legendHTML();
          return div.firstChild;
        };
        legendCtl.addTo(map);

        // ---- Data & filters ----
        let allProps = [];
        let allMarkers = [];
        function applyFilters() {
          const rvp   = document.getElementById('rvpFilter').value;
          const rpm   = document.getElementById('rpmFilter').value;
          const st    = document.getElementById('stateFilter').value;
          const type  = document.getElementById('typeFilter').value;
          const owner = document.getElementById('ownerFilter').value;
          const legal = document.getElementById('legalFilter').value;

          markersGroup.clearLayers();
          const rows = allMarkers.filter(({property:p}) => (
            (rvp==='All' || p.rvp===rvp) &&
            (rpm==='All' || p.rpm===rpm) &&
            (st==='All' || p.state===st) &&
            (type==='All' || p.type===type) &&
            (owner==='All' || p.owner===owner) &&
            (legal==='All' || p.legal_entity===legal)
          ));
          rows.forEach(({marker}) => markersGroup.addLayer(marker));
          updateCounts(rows.length);

          if (rows.length) {
            const grp = L.featureGroup(rows.map(r => r.marker));
            try { map.fitBounds(grp.getBounds(), { padding:[20,20] }); } catch(e){}
          }
        }

        const jsonUrl = './final_properties_with_coords_and_rvp.json?v=' + Date.now();
        fetch(jsonUrl)
          .then(r => { if (!r.ok) throw new Error('JSON fetch failed: ' + r.status + ' ' + r.statusText); return r.json(); })
          .then(data => {
            allProps = Array.isArray(data) ? data : [];
            allMarkers = allProps
              .filter(p => typeof p.lat === 'number' && typeof p.lng === 'number' &&
                           !Number.isNaN(p.lat) && !Number.isNaN(p.lng) &&
                           p.lat !== 0 && p.lng !== 0)
              .map(p => ({ property: p, marker: makeMarker(p) }));
            totalPortfolio = allProps.length;
            totalEligible  = allMarkers.length;

            addOptions('rvpFilter',   uniqueSorted(allProps.map(p => p.rvp)));
            addOptions('rpmFilter',   uniqueSorted(allProps.map(p => p.rpm)));
            addOptions('ownerFilter', uniqueSorted(allProps.map(p => p.owner)));
            addOptions('legalFilter', uniqueSorted(allProps.map(p => p.legal_entity)));

            applyFilters();
            ['rvpFilter','rpmFilter','stateFilter','typeFilter','ownerFilter','legalFilter']
              .forEach(id => document.getElementById(id).addEventListener('change', applyFilters));
          })
          .catch(err => {
            const box = document.getElementById('err');
            const pre = document.getElementById('errMsg');
            if (box && pre){ pre.textContent = 'Data load error:\n' + (err && err.stack ? err.stack : String(err)); box.style.display='block'; }
            console.error('Data load error:', err);
            updateCounts(0);
          });

      } catch (e) {
        const box = document.getElementById('err');
        const pre = document.getElementById('errMsg');
        if (box && pre){ pre.textContent = e && e.stack ? e.stack : String(e); box.style.display='block'; }
        console.error(e);
      }
    });
  </script>
</body>
</html>
