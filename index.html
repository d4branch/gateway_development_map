<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gateway Properties Map</title>

  <!-- main stylesheet -->
  <link rel="stylesheet" href="styles/app.css">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
  <!-- Header -->
  <div class="gaHeader">
    <h1>Gateway Properties Map</h1>
    <p class="sub">Property Filters</p>
  </div>

  <!-- Toolbar -->
  <div class="toolbar">
    <div class="group">
      <label for="rvpFilter">RVP</label>
      <select id="rvpFilter"><option value="All">All</option></select>
    </div>

    <div class="group">
      <label for="rpmFilter">Regional Manager</label>
      <select id="rpmFilter"><option value="All">All</option></select>
    </div>

    <div class="group">
      <label for="stateFilter">State</label>
      <select id="stateFilter">
        <option value="All">All</option>
        <option>AL</option><option>FL</option><option>GA</option><option>KS</option>
        <option>LA</option><option>NC</option><option>OK</option><option>SC</option>
        <option>TN</option><option>VA</option>
      </select>
    </div>

    <div class="group">
      <label for="typeFilter">Property Type</label>
      <select id="typeFilter">
        <option value="All">All</option>
        <option>55</option><option>62</option><option>C</option>
        <option>F</option><option>RD-62</option><option>S</option>
      </select>
    </div>

    <div class="group">
      <label for="ownerFilter">Owner</label>
      <select id="ownerFilter"><option value="All">All</option></select>
    </div>

    <div class="group">
      <label for="legalFilter">Legal Entity</label>
      <select id="legalFilter"><option value="All">All</option></select>
    </div>
  </div>

  <!-- Map -->
  <div id="map" class="map"></div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // Initialize map
    const map = L.map('map').setView([34.5, -86.6], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const markersGroup = L.layerGroup().addTo(map);
    let allProps = [];
    let allMarkers = [];

    function uniqueSorted(arr) {
      return [...new Set(arr.filter(Boolean))].sort((a, b) => a.localeCompare(b));
    }

    function addOptions(selectId, values) {
      const sel = document.getElementById(selectId);
      [...sel.querySelectorAll('option:not([value="All"])')].forEach(o => o.remove());
      values.forEach(v => {
        const opt = document.createElement('option');
        opt.value = v;
        opt.textContent = v;
        sel.appendChild(opt);
      });
    }

    function getMarkerOptions(type) {
      switch (type) {
        case '55': return { color: '#60d5d7', shape: 'circle' };
        case '62': return { color: '#10b981', shape: 'circle' };
        case 'F': return { color: '#f59e0b', shape: 'square' };
        case 'C': return { color: '#8b5cf6', shape: 'diamond' };
        case 'S': return { color: '#ef4444', shape: 'star' };
        case 'RD-62': return { color: '#10b981', shape: 'circle' };
        default: return { color: '#3b82f6', shape: 'circle' };
      }
    }

    function makeMarker(prop) {
      const opt = getMarkerOptions(prop.type);
      const icon = L.divIcon({
        html: `<div style="width:20px;height:20px;background:${opt.color};
                border-radius:${opt.shape === 'circle' ? '50%' : '0'};
                border:2px solid #fff;box-shadow:0 2px 4px rgba(0,0,0,.2);"></div>`,
        className: 'custom-div-icon',
        iconSize: [20, 20],
        iconAnchor: [10, 10]
      });
      const m = L.marker([prop.lat, prop.lng], { icon });
      m.bindPopup(
        `<div style="font-family:system-ui,sans-serif;min-width:280px">
          <h3 style="margin:0 0 8px;color:#073b3d;border-bottom:1px solid #60d5d7;padding-bottom:4px">
            ${prop.name} üè†</h3>
          <p><strong>Type:</strong> ${prop.type} &nbsp;|&nbsp; <strong>Units:</strong> ${prop.units ?? ''}</p>
          <p><strong>Address:</strong> ${prop.address}<br>${prop.city}, ${prop.state} ${prop.zip ?? ''}</p>
          <p><strong>Manager:</strong> ${prop.manager ?? ''}<br>
             <a href="mailto:${prop.manager_email ?? ''}" style="color:#0ea5e9">${prop.manager_email ?? ''}</a></p>
          <p><strong>RVP:</strong> ${prop.rvp ?? ''} &nbsp;|&nbsp; <strong>Regional:</strong> ${prop.rpm ?? ''}</p>
          <small style="color:#6b7280;border-top:1px solid #e5e7eb;padding-top:4px;display:block">
            Owner: ${prop.owner ?? 'N/A'} &nbsp;|&nbsp; Legal: ${prop.legal_entity ?? 'N/A'} &nbsp;|&nbsp; Phone: ${prop.office_phone ?? 'N/A'}
          </small>
        </div>`
      );
      return m;
    }

    function applyFilters() {
      const rvp   = document.getElementById('rvpFilter').value;
      const rpm   = document.getElementById('rpmFilter').value;
      const st    = document.getElementById('stateFilter').value;
      const type  = document.getElementById('typeFilter').value;
      const owner = document.getElementById('ownerFilter').value;
      const legal = document.getElementById('legalFilter').value;

      markersGroup.clearLayers();

      const rows = allMarkers.filter(({property:p}) => (
        (rvp   === 'All' || p.rvp === rvp) &&
        (rpm   === 'All' || p.rpm === rpm) &&
        (st    === 'All' || p.state === st) &&
        (type  === 'All' || p.type === type) &&
        (owner === 'All' || p.owner === owner) &&
        (legal === 'All' || p.legal_entity === legal)
      ));

      rows.forEach(({marker}) => markersGroup.addLayer(marker));

      if (rows.length) {
        const grp = L.featureGroup(rows.map(r => r.marker));
        map.fitBounds(grp.getBounds(), { padding: [20,20] });
      }
    }

    // Fetch JSON + build
    fetch('./final_properties_with_coords_and_rvp.json?cb=' + Date.now())
      .then(r => r.json())
      .then(data => {
        allProps = data;
        allMarkers = allProps
          .filter(p => p.lat && p.lng && p.lat !== 0 && p.lng !== 0)
          .map(p => ({ property: p, marker: makeMarker(p) }));

        // populate dropdowns
        addOptions('rvpFilter',   uniqueSorted(allProps.map(p => p.rvp)));
        addOptions('rpmFilter',   uniqueSorted(allProps.map(p => p.rpm)));
        addOptions('ownerFilter', uniqueSorted(allProps.map(p => p.owner)));
        addOptions('legalFilter', uniqueSorted(allProps.map(p => p.legal_entity)));

        // initial draw
        applyFilters();

        // bind filter events
        ['rvpFilter','rpmFilter','stateFilter','typeFilter','ownerFilter','legalFilter']
          .forEach(id => document.getElementById(id).addEventListener('change', applyFilters));
      })
      .catch(err => console.error('Error loading JSON:', err));
  </script>
</body>
</html>
