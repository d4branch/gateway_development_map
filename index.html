<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gateway Properties Map</title>
  <!-- Main stylesheet (teal header, toolbar, map height, + legend CSS appended) -->
  <link rel="stylesheet" href="styles/app.css" />
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
  <!-- Header -->
  <div class="gaHeader">
    <h1>Gateway Properties Map</h1>
    <p class="sub">Property Filters</p>
  </div>
  <!-- Toolbar -->
  <div class="toolbar">
    <div class="group">
      <label for="rvpFilter">RVP</label>
      <select id="rvpFilter"><option value="All">All</option></select>
    </div>
    <div class="group">
      <label for="rpmFilter">Regional Manager</label>
      <select id="rpmFilter"><option value="All">All</option></select>
    </div>
    <div class="group">
      <label for="stateFilter">State</label>
      <select id="stateFilter">
        <option value="All">All</option>
        <option>AL</option><option>FL</option><option>GA</option><option>KS</option>
        <option>LA</option><option>NC</option><option>OK</option><option>SC</option>
        <option>TN</option><option>VA</option>
      </select>
    </div>
    <div class="group">
      <label for="typeFilter">Property Type</label>
      <select id="typeFilter">
        <option value="All">All</option>
        <option>55</option><option>62</option><option>C</option>
        <option>F</option><option>RD-62</option><option>S</option>
      </select>
    </div>
    <div class="group">
      <label for="ownerFilter">Owner</label>
      <select id="ownerFilter"><option value="All">All</option></select>
    </div>
    <div class="group">
      <label for="legalFilter">Legal Entity</label>
      <select id="legalFilter"><option value="All">All</option></select>
    </div>
    <!-- New: Geocode Status Filter -->
    <div class="group">
      <label for="statusFilter">Geocode Status</label>
      <select id="statusFilter">
        <option value="All">All</option>
        <option value="ok">Ok</option>
        <option value="approx">Approx</option>
        <option value="failed">Failed</option>
      </select>
    </div>
    <!-- Export group -->
    <div class="group">
      <label>&nbsp;</label>
      <button id="btnUnmapped" title="Download a CSV of properties without coordinates">Download Unmapped CSV</button>
    </div>
  </div>
  <!-- Map -->
  <div id="map" class="map"></div>
  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // ---- Map init ----
    const map = L.map('map').setView([34.5, -86.6], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
    const markersGroup = L.layerGroup().addTo(map);
    let allProps = [];
    let allMarkers = []; // [{ property, marker }]
    let totalPortfolio = 0; // all rows in JSON
    let totalEligible = 0; // rows with usable coordinates
    // ---- Utils ----
    const uniqueSorted = arr => [...new Set(arr.filter(Boolean))].sort((a,b)=>a.localeCompare(b));
    function addOptions(selectId, values) {
      const sel = document.getElementById(selectId);
      [...sel.querySelectorAll('option:not([value="All"])')].forEach(o => o.remove());
      values.forEach(v => {
        const opt = document.createElement('option');
        opt.value = v; opt.textContent = v;
        sel.appendChild(opt);
      });
    }
    // Status colors (green/orange/red)
    function getStatusColor(status) {
      switch (status) {
        case 'ok': return '#10b981'; // green
        case 'approx': return '#f59e0b'; // orange
        case 'failed': return '#ef4444'; // red
        default: return '#6b7280'; // gray
      }
    }
    // Color/shape per Type (base color)
    function getMarkerOptions(type) {
      switch (type) {
        case '55': return { color: '#60d5d7', shape: 'circle' }; // teal circle
        case '62': return { color: '#10b981', shape: 'circle' }; // green circle
        case 'F': return { color: '#f59e0b', shape: 'square' }; // amber square
        case 'C': return { color: '#8b5cf6', shape: 'diamond' }; // purple diamond
        case 'S': return { color: '#ef4444', shape: 'star' }; // red star
        case 'RD-62':return { color: '#10b981', shape: 'circle' }; // green circle
        default: return { color: '#3b82f6', shape: 'circle' }; // blue circle
      }
    }
    // Create a marker with a divIcon shape that matches the legend + status tint (border/glow)
    function makeMarker(prop) {
      const opt = getMarkerOptions(prop.type);
      const statusColor = getStatusColor(prop.geocode_status || 'unknown');
      let shapeCSS = `width:20px;height:20px;background:${opt.color};border:2px solid ${statusColor};box-shadow:0 2px 4px rgba(0,0,0,.2);`;
      if (opt.shape === 'circle') {
        shapeCSS += 'border-radius:50%;';
      } else if (opt.shape === 'square') {
        shapeCSS += 'border-radius:4px;';
      } else if (opt.shape === 'diamond') {
        shapeCSS += 'transform:rotate(45deg);border-radius:3px;';
      } else if (opt.shape === 'star') {
        shapeCSS += 'clip-path:polygon(50% 0%,61% 35%,98% 35%,68% 57%,79% 91%,50% 70%,21% 91%,32% 57%,2% 35%,39% 35%);';
      }
      const icon = L.divIcon({
        html: `<div style="${shapeCSS}"></div>`,
        className: 'custom-div-icon',
        iconSize: [20,20],
        iconAnchor: [10,10]
      });
      const m = L.marker([prop.lat, prop.lng], { icon });
      m.bindPopup(
        `<div style="font-family:system-ui,sans-serif;min-width:280px">
          <h3 style="margin:0 0 8px;color:#073b3d;border-bottom:1px solid #60d5d7;padding-bottom:4px">
            ${prop.name} üè†</h3>
          <p><strong>Type:</strong> ${prop.type} &nbsp;|&nbsp; <strong>Units:</strong> ${prop.units ?? ''}</p>
          <p><strong>Address:</strong> ${prop.address}<br>${prop.city}, ${prop.state} ${prop.zip ?? ''}</p>
          <p><strong>Manager:</strong> ${prop.manager ?? ''}<br>
             <a href="mailto:${prop.manager_email ?? ''}" style="color:#0ea5e9">${prop.manager_email ?? ''}</a></p>
          <p><strong>RVP:</strong> ${prop.rvp ?? ''} &nbsp;|&nbsp; <strong>Regional:</strong> ${prop.rpm ?? ''}</p>
          <p><strong>Geocode Status:</strong> ${prop.geocode_status ?? 'unknown'} (${prop.geocode_source ?? 'none'})</p>
          <small style="color:#6b7280;border-top:1px solid #e5e7eb;padding-top:4px;display:block">
            Owner: ${prop.owner ?? 'N/A'} &nbsp;|&nbsp; Legal: ${prop.legal_entity ?? 'N/A'} &nbsp;|&nbsp; Phone: ${prop.office_phone ?? 'N/A'}
          </small>
        </div>`
      );
      return m;
    }
    // ---- Legend (with counts + status key) ----
    function legendHTML() {
      const items = [
        {label:'55+', type:'55'},
        {label:'62+', type:'62'},
        {label:'Family', type:'F'},
        {label:'Conv.', type:'C'},
        {label:'Senior', type:'S'},
        {label:'RD-62', type:'RD-62'},
      ];
      const rows = items.map(it => {
        const opt = getMarkerOptions(it.type);
        const shapeClass = ({circle:'circle', square:'square', diamond:'diamond', star:'star'})[opt.shape] || 'circle';
        return `<div class="row">
          <div class="swatch ${shapeClass}" style="background:${opt.color}"></div>
          <div>${it.label}</div>
        </div>`;
      }).join('');
      // Status key (simple dots)
      const statusRows = [
        {label:'Ok', status:'ok', color:'#10b981'},
        {label:'Approx', status:'approx', color:'#f59e0b'},
        {label:'Failed', status:'failed',
