<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gateway Property Map v2</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
        #map { height: 100vh; width: calc(100vw - 300px); float: right; }
        #sidebar { width: 300px; height: 100vh; padding: 20px; background: #f4f4f4; float: left; overflow-y: auto; }
        select { width: 100%; padding: 8px; margin-bottom: 10px; border-radius: 4px; }
        h2 { font-size: 1.5rem; font-weight: bold; margin-bottom: 15px; }
    </style>
</head>
<body>
    <div id="sidebar">
        <h2>Property Filters</h2>
        <label for="rvp-filter">Regional Manager</label>
        <select id="rvp-filter">
            <option value="">All</option>
            <!-- Dynamic options will go here if we add them -->
        </select>
        <label for="state-filter">State</label>
        <select id="state-filter">
            <option value="">All</option>
            <option>AL</option>
            <option>FL</option>
            <option>GA</option>
            <option>KS</option>
            <option>LA</option>
            <option>NC</option>
            <option>OK</option>
            <option>SC</option>
            <option>TN</option>
            <option>VA</option>
        </select>
        <label for="type-filter">Property Type</label>
        <select id="type-filter">
            <option value="">All</option>
            <option>55</option>
            <option>62</option>
            <option>C</option>
            <option>F</option>
            <option>RD-62</option>
            <option>S</option>
        </select>
        <label for="owner-filter">Owner</label>
        <select id="owner-filter">
            <option value="">All</option>
            <option>TBD</option>
        </select>
        <label for="legal-entity-filter">Legal Entity</label>
        <select id="legal-entity-filter">
            <option value="">All</option>
            <option>TBD</option>
        </select>
    </div>
    <div id="map"></div>
    <script>
        // Initialize Leaflet map with OpenStreetMap tiles
        const map = L.map('map', {
            center: [32.8, -86.6], // Centered on Alabama
            zoom: 6,
            maxBounds: [
                [24.396308, -125.0],
                [49.384358, -66.93457]
            ],
            maxBoundsViscosity: 1.0
        });

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19
        }).addTo(map);

        let allProperties = []; // Global to hold data for filtering

        // Load data and add markers
        async function loadMapData() {
            try {
                const response = await fetch('https://raw.githubusercontent.com/d4branch/gateway_development_map/main/final_properties_with_coords_and_rvp.json?cb=' + Date.now());
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                allProperties = await response.json();

                // Function to add markers
                function addMarkers(data) {
                    map.eachLayer(layer => {
                        if (layer instanceof L.CircleMarker) {
                            map.removeLayer(layer);
                        }
                    });

                    data.forEach((property) => {
                        if (!property.lat || !property.lng || property.lat === 0 || property.lng === 0) return;

                        const marker = L.circleMarker([property.lat, property.lng], {
                            radius: 8,
                            fillColor: "#007BFF",
                            color: "#000",
                            weight: 1,
                            opacity: 1,
                            fillOpacity: 0.8
                        });

                        const popupContent = `
                            <b>${property.name}</b><br>
                            ${property.address}<br>
                            ${property.city}, ${property.state} ${property.zip}<br><br>
                            Phone: ${property.office_phone}<br>
                            Email: ${property.manager_email}<br><br>
                            Regional: ${property.rvp}<br>
                            Compliance: ${property.compliance}<br>
                            Owner: ${property.owner}<br>
                            Legal Entity: ${property.legal_entity}
                        `;
                        marker.bindPopup(popupContent);
                        marker.addTo(map);
                    });
                }

                // Initial load of all markers
                addMarkers(allProperties);

                // Filter function
                function updateMarkers() {
                    const rvp = document.getElementById('rvp-filter').value;
                    const state = document.getElementById('state-filter').value;
                    const type = document.getElementById('type-filter').value;
                    const owner = document.getElementById('owner-filter').value;
                    const legalEntity = document.getElementById('legal-entity-filter').value;

                    const filtered = allProperties.filter(p => (
                        (!rvp || p.rvp === rvp) &&
                        (!state || p.state === state) &&
                        (!type || p.type === type) &&
                        (!owner || p.owner === owner) &&
                        (!legalEntity || p.legal_entity === legalEntity)
                    ));

                    addMarkers(filtered);
                }

                // Add filter event listeners
                document.getElementById('rvp-filter').addEventListener('change', updateMarkers);
                document.getElementById('state-filter').addEventListener('change', updateMarkers);
                document.getElementById('type-filter').addEventListener('change', updateMarkers);
                document.getElementById('owner-filter').addEventListener('change', updateMarkers);
                document.getElementById('legal-entity-filter').addEventListener('change', updateMarkers);

                // Initial filter application (should show all)
                updateMarkers();

                console.log(`Loaded ${allProperties.length} properties.`);
            } catch (error) {
                console.error('Failed to load properties:', error);
                alert('Error loading JSON data. Check the console for details.');
            }
        }

        // Run the data loading when the page loads
        window.onload = loadMapData;
    </script>
</body>
</html>
